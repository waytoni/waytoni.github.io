<!DOCTYPE html>
<html lang="si">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GT-MBNDJTD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'GT-MBNDJTD');
    </script>
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">   
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="stylesheet" type="text/css" href="/css/nav_menu.css">
    <link rel="stylesheet" type="text/css" href="/css/$CSSFILE$">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="/scripts/nav_function.js"></script>

    
    
    
    <title>$TITLE$</title>
</head>
<body>
$NAVIGATION_HEADER$

    <div class="container">
        <div class="hero-section">
            $INTRO_SECTION$
        </div>

        <div class="info-grid">
            $TIME_BLOCK$
            
            $LOCATION_BLOCK$

            $CONTACT_BLOCK$

            
            <div class="info-card">
                <h3><i class="fa fa-file"></i>දේශනා සඳහා සටහන්</h3>
            <p><a href="/documents/NotesForDesana/NotesForDesana.html">සියලු දේශනා සඳහා සටහන්</a></p>
            </div>
            
            $ZOOM_INFO_BLOCK$

        </div>
        
        <div class="video-container">
            <div class="video-controls">
                <select id="link-selector" class="video-selector" onchange="updateContent()">
                    <!-- Options will be populated dynamically -->
                </select>
                <div class="nav-buttons">
                    <button class="nav-button" onclick="navigate(-1)">පෙර දේශනාව</button>
                    <button class="nav-button" onclick="navigate(1)">මීළඟ දේශනාව</button>
                </div>
            </div>
            
            <div id="video-container">
                <!-- YouTube video will be embedded here -->
            </div>
        </div>

        <div class="notes-container">
            <h3>
                දේශනාව සඳහා සටහන්
                <div class="font-control">
                    <label for="fontSizeSlider">අකුරු ප්‍රමාණය:</label>
                    <input type="range" id="fontSizeSlider" class="font-slider" min="12" max="36" value="16">
                </div>
            </h3>
            <div id="notes" class="notes-content">
                <!-- Notes will be displayed here -->
            </div>
        </div>
    </div>

    <script>
        let data;
        let seriesTitle = "$SERIESTITLE$"; // Changeable series title   
        
        // Fetch the JSON data and populate the dropdown menu
        fetch('$JSON_FILE$').then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        }).then(json => {
            data = json;
            populateDropdown();
            displayLastEntry();
        }).catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
        
        // Function to populate the dropdown menu
        function populateDropdown() {
            const selector = document.getElementById('link-selector');
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.url;
                option.text = item.comment ? `${item.index} ●  ${item.comment} ● ${item.date}` :
                    `${item.index} ●  ${seriesTitle} ● ${item.date}`;
                option.dataset.index = item.index;
                selector.appendChild(option);
            });
        }
        
        // Function to update the YouTube video and notes based on the selected option
        function updateContent_old() {
            const selector = document.getElementById('link-selector');
            const selectedOption = selector.options[selector.selectedIndex];
            const url = selectedOption.value;
            const index = selectedOption.dataset.index;
            const notes = data.find(item => item.index == index).notes;
            const videoContainer = document.getElementById('video-container');
            
            videoContainer.innerHTML = 
                `<iframe class="youtube-frame" src="${url.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe>`;
            
            const notesContainer = document.getElementById('notes');
            notesContainer.innerHTML = notes || '<p>මෙම දේශනාව සඳහා සටහන් නොමැත.</p>';
        }
        

          function updateContent() {
            const selector = document.getElementById('link-selector');
            const selectedOption = selector.options[selector.selectedIndex];
            const url = selectedOption.value;
            const index = selectedOption.dataset.index;
            const selectedData = data.find(item => item.index == index);
            const videoId = selectedData.video_id;
            const notes = selectedData.notes;
            const videoContainer = document.getElementById('video-container');
            // Check if video_id starts with "INVALID:"
            if (videoId.startsWith('INVALID:')) {
                // Extract the message after "INVALID:" and replace underscores with spaces
                const rawMessage = videoId.substring(8).trim();
                const formattedMessage = rawMessage.replace(/_/g, ' ');
                // Create a styled message display instead of a YouTube video
                videoContainer.innerHTML = `
            <div class="invalid-video-message">
                <div class="message-icon">⚠️</div>
                <h3>දේශනාව නොමැත</h3>
                <p>${formattedMessage || 'මෙම දේශනාව මේ වන විට නොමැත.'}</p>
                <div class="message-details">
                    <p><strong>දේශනා අංකය:</strong> ${selectedData.index}</p>
                    <p><strong>දිනය:</strong> ${selectedData.date_string}</p>
                    ${selectedData.comment ? `<p><strong>විස්තරය:</strong> ${selectedData.comment}</p>` : ''}
                </div>
            </div>
        `;
            } else {
                // Valid YouTube video - embed normally
                videoContainer.innerHTML =
                    `<iframe class="youtube-frame" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
            }
            const notesContainer = document.getElementById('notes');
            notesContainer.innerHTML = notes || '<p>මෙම දේශනාව සඳහා සටහන් නොමැත.</p>';
        }
        
        // Function to display the last entry from the JSON data on the initial load
        function displayLastEntry() {
            if (data.length > 0) {
                // const lastEntry = data[data.length - 1];
                const lastEntry = $LASTENTRY$;
                const selector = document.getElementById('link-selector');
                selector.value = lastEntry.url;
                updateContent();
            }
        }
        
        // Function to navigate to the previous or next video
        function navigate(direction) {
            const selector = document.getElementById('link-selector');
            let newIndex = selector.selectedIndex + direction;
            if (newIndex < 0) {
                newIndex = selector.options.length - 1;
            } else if (newIndex >= selector.options.length) {
                newIndex = 0;
            }
            selector.selectedIndex = newIndex;
            updateContent();
        }
        
        // Font size slider functionality
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const notesContent = document.getElementById('notes');
        
        fontSizeSlider.addEventListener('input', function () {
            const newFontSize = `${fontSizeSlider.value}px`;
            notesContent.style.fontSize = newFontSize;
        });
    </script>
</body>
</html>