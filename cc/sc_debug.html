<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel-like Frozen Pane Viewer - Enhanced Debug</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #f0f0f0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Top Row: Header */
        .header-row {
            flex-shrink: 0;
            border-bottom: 2px solid #666;
            background-color: #fff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #headerContainer {
            position: relative;
            overflow: hidden;
            height: auto;
        }

        /* Middle Row: Left Column + Main Content */
        .content-row {
            display: flex;
            flex: 1;
            min-height: 0;
            width: 100%;
        }

        /* Left column (frozen) */
        .left-column {
            flex-shrink: 0;
            background-color: #f8f8f8;
            border-right: 2px solid #666;
            position: relative;
            overflow: hidden;
        }

        #leftColumnContainer {
            position: relative;
            overflow: hidden;
        }

        /* Main content area with scrollbars */
        .main-content {
            flex: 1;
            position: relative;
            overflow: auto;
            background-color: #fafafa;
        }

        #mainContentContainer {
            position: relative;
        }

        /* Canvas styling */
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Custom scrollbar styling */
        .main-content::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }

        .main-content::-webkit-scrollbar-track {
            background: #e8e8e8;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 7px;
            border: 3px solid #e8e8e8;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .main-content::-webkit-scrollbar-corner {
            background: #e8e8e8;
        }

        .scroll-info {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .zoom-controls {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 5px;
        }

        .zoom-controls button {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.2s;
            min-width: 50px;
        }

        .zoom-controls button:hover {
            background: rgba(0, 0, 0, 0.95);
        }

        #resetZoom {
            background: rgba(52, 152, 219, 0.85);
        }

        #resetZoom:hover {
            background: rgba(41, 128, 185, 0.95);
        }

        .debug-panel {
            position: fixed;
            top: 60px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 500px;
            overflow: auto;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .debug-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .debug-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .debug-value {
            color: #666;
        }

        .debug-warning {
            color: #e74c3c;
            font-weight: bold;
        }

        .debug-ok {
            color: #27ae60;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Row: Full Header -->
        <div class="header-row" id="headerContainer">
            <canvas id="headerCanvas"></canvas>
        </div>
        
        <!-- Middle Row: Left Column + Main Content -->
        <div class="content-row">
            <div class="left-column" id="leftColumnContainer">
                <canvas id="leftColumnCanvas"></canvas>
            </div>
            <div class="main-content" id="mainContentContainer">
                <canvas id="mainContentCanvas"></canvas>
            </div>
        </div>
    </div>

    <div class="zoom-controls">
        <button id="zoomOut">-</button>
        <button id="resetZoom">Fit</button>
        <button id="zoomIn">+</button>
    </div>

    <div class="debug-panel" id="debugPanel">
        <div class="debug-section">
            <div class="debug-title">Zoom & Scale</div>
            <div id="debugScale">Scale: --</div>
            <div id="debugActualScale">Actual Scale: --</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">Image Dimensions</div>
            <div id="debugHeaderImage">Header: --</div>
            <div id="debugLeftImage">Left Column: --</div>
            <div id="debugMainImage">Main Content: --</div>
            <div id="debugHeightMatch" class="debug-warning">Height Match: Checking...</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">Canvas Dimensions</div>
            <div id="debugHeaderCanvas">Header Canvas: --</div>
            <div id="debugLeftCanvas">Left Canvas: --</div>
            <div id="debugMainCanvas">Main Canvas: --</div>
            <div id="debugCanvasHeightMatch" class="debug-warning">Canvas Height Match: Checking...</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">Scroll Position</div>
            <div id="debugScrollX">Scroll X: --</div>
            <div id="debugScrollY">Scroll Y: --</div>
            <div id="debugMaxScroll">Max Scroll: --</div>
            <div id="debugScrollPercent">Scroll %: --</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">Translation Values</div>
            <div id="debugLeftTranslation">Left Canvas Translate Y: --</div>
            <div id="debugMainTranslation">Main Canvas Translate Y: --</div>
            <div id="debugTranslationMatch" class="debug-warning">Translation Match: Checking...</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">Container Sizes</div>
            <div id="debugViewport">Viewport: --</div>
            <div id="debugMainContainer">Main Container: --</div>
            <div id="debugHeaderContainer">Header Container: --</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">Calculated Values</div>
            <div id="debugScrollRatio">ScrollY to ImageY Ratio: --</div>
            <div id="debugExpectedImageY">Expected Image Y Position: --</div>
        </div>
    </div>

    <div class="scroll-info" id="scrollInfo">Zoom: Fit</div>

    <script>
        // Get DOM elements
        const headerCanvas = document.getElementById('headerCanvas');
        const leftColumnCanvas = document.getElementById('leftColumnCanvas');
        const mainContentCanvas = document.getElementById('mainContentCanvas');
        
        const headerContainer = document.getElementById('headerContainer');
        const leftColumnContainer = document.getElementById('leftColumnContainer');
        const mainContentContainer = document.getElementById('mainContentContainer');
        
        const scrollInfo = document.getElementById('scrollInfo');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const resetZoomBtn = document.getElementById('resetZoom');
        
        // Debug elements
        const debugScale = document.getElementById('debugScale');
        const debugActualScale = document.getElementById('debugActualScale');
        const debugHeaderImage = document.getElementById('debugHeaderImage');
        const debugLeftImage = document.getElementById('debugLeftImage');
        const debugMainImage = document.getElementById('debugMainImage');
        const debugHeightMatch = document.getElementById('debugHeightMatch');
        const debugHeaderCanvas = document.getElementById('debugHeaderCanvas');
        const debugLeftCanvas = document.getElementById('debugLeftCanvas');
        const debugMainCanvas = document.getElementById('debugMainCanvas');
        const debugCanvasHeightMatch = document.getElementById('debugCanvasHeightMatch');
        const debugScrollX = document.getElementById('debugScrollX');
        const debugScrollY = document.getElementById('debugScrollY');
        const debugMaxScroll = document.getElementById('debugMaxScroll');
        const debugScrollPercent = document.getElementById('debugScrollPercent');
        const debugLeftTranslation = document.getElementById('debugLeftTranslation');
        const debugMainTranslation = document.getElementById('debugMainTranslation');
        const debugTranslationMatch = document.getElementById('debugTranslationMatch');
        const debugViewport = document.getElementById('debugViewport');
        const debugMainContainer = document.getElementById('debugMainContainer');
        const debugHeaderContainer = document.getElementById('debugHeaderContainer');
        const debugScrollRatio = document.getElementById('debugScrollRatio');
        const debugExpectedImageY = document.getElementById('debugExpectedImageY');
        
        // Create contexts
        const headerCtx = headerCanvas.getContext('2d');
        const leftColumnCtx = leftColumnCanvas.getContext('2d');
        const mainContentCtx = mainContentCanvas.getContext('2d');
        
        // Image variables
        let headerImage = null;
        let leftColumnImage = null;
        let mainContentImage = null;
        let imagesLoaded = 0;
        const totalImages = 3;
        
        // Discovered dimensions
        let HEADER_WIDTH = 0;
        let HEADER_HEIGHT = 0;
        let LEFT_COLUMN_WIDTH = 0;
        let BODY_HEIGHT = 0;
        let MAIN_CONTENT_WIDTH = 0;
        
        // Zoom settings
        let scale = 1.0;
        const MIN_SCALE = 0.05;
        const MAX_SCALE = 3.0;
        const SCALE_STEP = 0.1;
        
        // Store image data
        let headerImageData = null;
        let leftColumnImageData = null;
        let mainContentImageData = null;
        
        // Debug logs
        let debugLogs = [];
        
        function addDebugLog(message) {
            debugLogs.push(`${new Date().toLocaleTimeString()}: ${message}`);
            if (debugLogs.length > 10) debugLogs.shift();
            console.log(message);
        }
        
        // Update all debug info
        function updateAllDebugInfo() {
            const scrollX = mainContentContainer.scrollLeft;
            const scrollY = mainContentContainer.scrollTop;
            const maxScrollX = Math.max(0, mainContentCanvas.width - mainContentContainer.clientWidth);
            const maxScrollY = Math.max(0, mainContentCanvas.height - mainContentContainer.clientHeight);
            const percentX = maxScrollX > 0 ? Math.round((scrollX / maxScrollX) * 100) : 0;
            const percentY = maxScrollY > 0 ? Math.round((scrollY / maxScrollY) * 100) : 0;
            
            // Calculate actual scale factors
            const leftCanvasScaleY = leftColumnCanvas.height / BODY_HEIGHT;
            const mainCanvasScaleY = mainContentCanvas.height / BODY_HEIGHT;
            
            // What image Y position should be at top of viewport
            const expectedImageY = scrollY / leftCanvasScaleY;
            
            debugScale.textContent = `Scale: ${scale.toFixed(4)} (${Math.round(scale * 100)}%)`;
            debugActualScale.textContent = `Actual Scale - Left: ${leftCanvasScaleY.toFixed(4)}, Main: ${mainCanvasScaleY.toFixed(4)}`;
            
            debugHeaderImage.textContent = `Header: ${HEADER_WIDTH} × ${HEADER_HEIGHT}`;
            debugLeftImage.textContent = `Left Column: ${LEFT_COLUMN_WIDTH} × ${BODY_HEIGHT}`;
            debugMainImage.textContent = `Main Content: ${MAIN_CONTENT_WIDTH} × ${BODY_HEIGHT}`;
            
            if (leftColumnImageData && mainContentImageData) {
                const leftHeight = leftColumnImageData.height;
                const mainHeight = mainContentImageData.height;
                if (leftHeight === mainHeight) {
                    debugHeightMatch.textContent = `Height Match: ✓ Perfect (${leftHeight}px)`;
                    debugHeightMatch.className = 'debug-ok';
                } else {
                    debugHeightMatch.textContent = `Height Match: ✗ MISMATCH! Left: ${leftHeight}px, Main: ${mainHeight}px`;
                    debugHeightMatch.className = 'debug-warning';
                }
            }
            
            debugHeaderCanvas.textContent = `Header Canvas: ${headerCanvas.width} × ${headerCanvas.height}`;
            debugLeftCanvas.textContent = `Left Canvas: ${leftColumnCanvas.width} × ${leftColumnCanvas.height}`;
            debugMainCanvas.textContent = `Main Canvas: ${mainContentCanvas.width} × ${mainContentCanvas.height}`;
            
            if (leftColumnCanvas.height === mainContentCanvas.height) {
                debugCanvasHeightMatch.textContent = `Canvas Height Match: ✓ Perfect (${leftColumnCanvas.height}px)`;
                debugCanvasHeightMatch.className = 'debug-ok';
            } else {
                debugCanvasHeightMatch.textContent = `Canvas Height Match: ✗ MISMATCH! Left: ${leftColumnCanvas.height}px, Main: ${mainContentCanvas.height}px`;
                debugCanvasHeightMatch.className = 'debug-warning';
            }
            
            debugScrollX.textContent = `Scroll X: ${Math.round(scrollX)} / ${Math.round(maxScrollX)}`;
            debugScrollY.textContent = `Scroll Y: ${Math.round(scrollY)} / ${Math.round(maxScrollY)}`;
            debugMaxScroll.textContent = `Max Scroll: X=${Math.round(maxScrollX)}, Y=${Math.round(maxScrollY)}`;
            debugScrollPercent.textContent = `Scroll %: X=${percentX}%, Y=${percentY}%`;
            
            debugLeftTranslation.textContent = `Left Canvas Translate Y: -${Math.round(scrollY)}px`;
            debugMainTranslation.textContent = `Main Canvas Translate Y: -${Math.round(scrollY)}px`;
            
            if (leftCanvasScaleY.toFixed(4) === mainCanvasScaleY.toFixed(4)) {
                debugTranslationMatch.textContent = `Translation Match: ✓ Same scale factor`;
                debugTranslationMatch.className = 'debug-ok';
            } else {
                debugTranslationMatch.textContent = `Translation Match: ✗ DIFFERENT scales! Left: ${leftCanvasScaleY.toFixed(4)}, Main: ${mainCanvasScaleY.toFixed(4)}`;
                debugTranslationMatch.className = 'debug-warning';
            }
            
            debugViewport.textContent = `Viewport: ${window.innerWidth} × ${window.innerHeight}`;
            debugMainContainer.textContent = `Main Container: ${mainContentContainer.clientWidth} × ${mainContentContainer.clientHeight}`;
            debugHeaderContainer.textContent = `Header Container: ${headerContainer.clientWidth} × ${headerContainer.clientHeight}`;
            
            debugScrollRatio.textContent = `ScrollY to ImageY Ratio: 1px scroll = ${(1/leftCanvasScaleY).toFixed(2)}px image`;
            debugExpectedImageY.textContent = `Expected Image Y Position: ${Math.round(expectedImageY)}px`;
            
            // Update scroll info
            scrollInfo.textContent = `H: ${Math.round(scrollX)}/${Math.round(maxScrollX)} (${percentX}%) | V: ${Math.round(scrollY)}/${Math.round(maxScrollY)} (${percentY}%) | Zoom: ${Math.round(scale * 100)}%`;
            resetZoomBtn.textContent = `${Math.round(scale * 100)}%`;
        }
        
        // Calculate fit scale
        function calculateFitScale() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight - 100;
            
            if (MAIN_CONTENT_WIDTH === 0) return 0.25;
            
            const widthScale = (viewportWidth - LEFT_COLUMN_WIDTH) / MAIN_CONTENT_WIDTH;
            const totalHeightAtScale = (HEADER_HEIGHT + BODY_HEIGHT) * widthScale;
            
            if (totalHeightAtScale <= viewportHeight) {
                return widthScale * 0.95;
            }
            
            const heightScale = viewportHeight / (HEADER_HEIGHT + BODY_HEIGHT);
            return heightScale * 0.95;
        }
        
        // Initialize canvases
        function initCanvas() {
            // Calculate scaled dimensions
            const scaledHeaderHeight = Math.max(1, Math.floor(HEADER_HEIGHT * scale));
            const scaledHeaderWidth = Math.max(1, Math.floor(HEADER_WIDTH * scale));
            const scaledLeftColumnWidth = Math.max(1, Math.floor(LEFT_COLUMN_WIDTH * scale));
            const scaledLeftColumnHeight = Math.max(1, Math.floor(BODY_HEIGHT * scale));
            const scaledMainContentWidth = Math.max(1, Math.floor(MAIN_CONTENT_WIDTH * scale));
            const scaledMainContentHeight = Math.max(1, Math.floor(BODY_HEIGHT * scale));
            
            addDebugLog(`initCanvas: scale=${scale}, leftCanvasHeight=${scaledLeftColumnHeight}, mainCanvasHeight=${scaledMainContentHeight}`);
            
            // Set header
            headerContainer.style.height = scaledHeaderHeight + 'px';
            headerCanvas.width = scaledHeaderWidth;
            headerCanvas.height = scaledHeaderHeight;
            
            // Set left column
            leftColumnContainer.style.width = scaledLeftColumnWidth + 'px';
            leftColumnCanvas.width = scaledLeftColumnWidth;
            leftColumnCanvas.height = scaledLeftColumnHeight;
            
            // Set main content
            mainContentCanvas.width = scaledMainContentWidth;
            mainContentCanvas.height = scaledMainContentHeight;
            
            // Update debug info
            updateAllDebugInfo();
            
            // Draw
            drawAllSections();
        }
        
        // Load images
        function loadImages() {
            headerImage = new Image();
            leftColumnImage = new Image();
            mainContentImage = new Image();
            
            const onImageLoad = function() {
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    // Discover actual dimensions
                    HEADER_WIDTH = headerImage.width;
                    HEADER_HEIGHT = headerImage.height;
                    LEFT_COLUMN_WIDTH = leftColumnImage.width;
                    BODY_HEIGHT = leftColumnImage.height;
                    MAIN_CONTENT_WIDTH = mainContentImage.width;
                    
                    addDebugLog(`Images loaded: Header=${HEADER_WIDTH}x${HEADER_HEIGHT}, Left=${LEFT_COLUMN_WIDTH}x${BODY_HEIGHT}, Main=${MAIN_CONTENT_WIDTH}x${mainContentImage.height}`);
                    
                    // Check height consistency
                    if (leftColumnImage.height !== mainContentImage.height) {
                        addDebugLog(`WARNING: Image height mismatch! Left: ${leftColumnImage.height}, Main: ${mainContentImage.height}`);
                        BODY_HEIGHT = Math.min(leftColumnImage.height, mainContentImage.height);
                    }
                    
                    // Store image data
                    headerImageData = headerImage;
                    leftColumnImageData = leftColumnImage;
                    mainContentImageData = mainContentImage;
                    
                    // Set initial scale
                    scale = calculateFitScale();
                    addDebugLog(`Initial scale calculated: ${scale}`);
                    
                    initCanvas();
                    setupEventListeners();
                    
                    // Initial draw
                    drawAllSections();
                }
            };
            
            headerImage.onload = onImageLoad;
            leftColumnImage.onload = onImageLoad;
            mainContentImage.onload = onImageLoad;
            
            // Load images
            headerImage.src = 'cc_h.jpg';
            leftColumnImage.src = 'body_left.jpg';
            mainContentImage.src = 'body_right.jpg';
        }
        
        // Draw all sections
        function drawAllSections() {
            const scrollX = mainContentContainer.scrollLeft;
            const scrollY = mainContentContainer.scrollTop;
            
            addDebugLog(`drawAllSections: scrollY=${scrollY}, leftCanvas.height=${leftColumnCanvas.height}, mainCanvas.height=${mainContentCanvas.height}`);
            
            // Clear
            headerCtx.clearRect(0, 0, headerCanvas.width, headerCanvas.height);
            leftColumnCtx.clearRect(0, 0, leftColumnCanvas.width, leftColumnCanvas.height);
            mainContentCtx.clearRect(0, 0, mainContentCanvas.width, mainContentCanvas.height);
            
            // Draw HEADER
            if (headerImageData && headerImageData.complete) {
                headerCtx.save();
                headerCtx.translate(-scrollX, 0);
                headerCtx.drawImage(
                    headerImageData,
                    0, 0, HEADER_WIDTH, HEADER_HEIGHT,
                    0, 0, headerCanvas.width, headerCanvas.height
                );
                headerCtx.restore();
            }
            
            // Draw LEFT COLUMN
            if (leftColumnImageData && leftColumnImageData.complete) {
                leftColumnCtx.save();
                leftColumnCtx.translate(0, -scrollY);
                leftColumnCtx.drawImage(
                    leftColumnImageData,
                    0, 0, LEFT_COLUMN_WIDTH, BODY_HEIGHT,
                    0, 0, leftColumnCanvas.width, leftColumnCanvas.height
                );
                leftColumnCtx.restore();
            }
            
            // Draw MAIN CONTENT
            if (mainContentImageData && mainContentImageData.complete) {
                mainContentCtx.save();
                mainContentCtx.translate(-scrollX, -scrollY);
                mainContentCtx.drawImage(
                    mainContentImageData,
                    0, 0, MAIN_CONTENT_WIDTH, BODY_HEIGHT,
                    0, 0, mainContentCanvas.width, mainContentCanvas.height
                );
                mainContentCtx.restore();
            }
            
            updateAllDebugInfo();
        }
        
        // Update zoom
        function updateZoom(newScale) {
            newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
            
            if (scale === newScale) return;
            
            addDebugLog(`updateZoom: ${scale} -> ${newScale}`);
            
            // Store current position as percentages
            const scrollX = mainContentContainer.scrollLeft;
            const scrollY = mainContentContainer.scrollTop;
            const maxScrollX = Math.max(1, mainContentCanvas.width - mainContentContainer.clientWidth);
            const maxScrollY = Math.max(1, mainContentCanvas.height - mainContentContainer.clientHeight);
            
            const percentX = scrollX / maxScrollX;
            const percentY = scrollY / maxScrollY;
            
            // Update scale
            const oldScale = scale;
            scale = newScale;
            
            // Reinitialize
            initCanvas();
            
            // Restore position
            const newMaxScrollX = Math.max(0, mainContentCanvas.width - mainContentContainer.clientWidth);
            const newMaxScrollY = Math.max(0, mainContentCanvas.height - mainContentContainer.clientHeight);
            
            const newScrollX = percentX * newMaxScrollX;
            const newScrollY = percentY * newMaxScrollY;
            
            mainContentContainer.scrollLeft = Math.max(0, Math.min(newScrollX, newMaxScrollX));
            mainContentContainer.scrollTop = Math.max(0, Math.min(newScrollY, newMaxScrollY));
            headerContainer.scrollLeft = mainContentContainer.scrollLeft;
            
            addDebugLog(`Zoom applied: scale ${oldScale}->${scale}, scrollY ${scrollY}->${newScrollY}`);
            
            drawAllSections();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            let isDragging = false;
            let startX, startY, startScrollLeft, startScrollTop;
            
            function handleDragStart(e) {
                isDragging = true;
                startX = e.clientX || e.touches[0].clientX;
                startY = e.clientY || e.touches[0].clientY;
                startScrollLeft = mainContentContainer.scrollLeft;
                startScrollTop = mainContentContainer.scrollTop;
                document.body.style.cursor = 'grabbing';
                e.preventDefault();
            }
            
            function handleDragMove(e) {
                if (!isDragging) return;
                
                const currentX = e.clientX || e.touches[0].clientX;
                const currentY = e.clientY || e.touches[0].clientY;
                
                const deltaX = startX - currentX;
                const deltaY = startY - currentY;
                
                const newScrollLeft = startScrollLeft + deltaX;
                const newScrollTop = startScrollTop + deltaY;
                
                const maxScrollLeft = Math.max(0, mainContentCanvas.width - mainContentContainer.clientWidth);
                const maxScrollTop = Math.max(0, mainContentCanvas.height - mainContentContainer.clientHeight);
                
                mainContentContainer.scrollLeft = Math.max(0, Math.min(newScrollLeft, maxScrollLeft));
                mainContentContainer.scrollTop = Math.max(0, Math.min(newScrollTop, maxScrollTop));
                headerContainer.scrollLeft = mainContentContainer.scrollLeft;
                
                e.preventDefault();
            }
            
            function handleDragEnd() {
                isDragging = false;
                document.body.style.cursor = 'default';
            }
            
            // Add event listeners
            [headerCanvas, leftColumnCanvas, mainContentCanvas].forEach(canvas => {
                canvas.addEventListener('mousedown', handleDragStart);
                canvas.addEventListener('mousemove', handleDragMove);
                canvas.addEventListener('mouseup', handleDragEnd);
                canvas.addEventListener('mouseleave', handleDragEnd);
                
                canvas.addEventListener('touchstart', handleDragStart, { passive: false });
                canvas.addEventListener('touchmove', handleDragMove, { passive: false });
                canvas.addEventListener('touchend', handleDragEnd);
                canvas.addEventListener('touchcancel', handleDragEnd);
                
                canvas.style.cursor = 'grab';
            });
            
            // Scroll events
            mainContentContainer.addEventListener('scroll', () => {
                headerContainer.scrollLeft = mainContentContainer.scrollLeft;
                drawAllSections();
            });
            
            // Zoom controls
            zoomInBtn.addEventListener('click', () => updateZoom(scale + SCALE_STEP));
            zoomOutBtn.addEventListener('click', () => updateZoom(scale - SCALE_STEP));
            resetZoomBtn.addEventListener('click', () => {
                scale = calculateFitScale();
                initCanvas();
                drawAllSections();
            });
            
            // Mouse wheel zoom
            document.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -SCALE_STEP : SCALE_STEP;
                    updateZoom(scale + delta);
                }
            }, { passive: false });
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (imagesLoaded === totalImages) {
                drawAllSections();
                updateAllDebugInfo();
            }
        });
        
        // Start loading images
        loadImages();
    </script>
</body>
</html>